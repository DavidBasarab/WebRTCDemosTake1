<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
</head>
<body>

    <h1>Video Chat</h1>
    <video id="local-video" height="150" autoplay></video>
    
    <canvas id="meter" width="50" height="150"></canvas>

    <script src="volume-meter.js"></script>
    <script type="text/javascript" language="javascript">
    var PeerConnection = window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    var IceCandidate = window.mozRTCIceCandidate || window.RTCIceCandidate;
    var SessionDescription = window.mozRTCSessionDescription || window.RTCSessionDescription;
    window.AudioContext = window.AudioContext || window.webkitAudioContext;


    navigator.getUserMedia = (navigator.getUserMedia ||
                       navigator.webkitGetUserMedia ||
                       navigator.mozGetUserMedia ||
                       navigator.msGetUserMedia);

    var canvasContext = document.getElementById("meter").getContext("2d");

    var audioContext = new AudioContext();

    if (navigator.getUserMedia) {
        navigator.getUserMedia(
            { audio: true, video: true },
            function(localMediaStream) {
                var video = document.querySelector("video#local-video");
                video.src = window.URL.createObjectURL(localMediaStream);

                var mediaStreamSource = audioContext.createMediaStreamSource(localMediaStream);
                meter = createAudioMeter(audioContext);
                mediaStreamSource.connect(meter);

                drawLoop();
            },
            function(err) {
                console.log(err);
            }
        );
    }
    else {
        console.log('no user media for you');
    }

    
    
    var height = 150;
    var width = 25;

    function drawLoop( time ) {
        // clear the background
        canvasContext.clearRect(0,0,width,height);

        // check if we're currently clipping
        if (meter.checkClipping())
            canvasContext.fillStyle = "red";
        else
            canvasContext.fillStyle = "green";

        // draw a bar based on the current volume
        canvasContext.fillRect(0, 0, width, meter.volume*height*1.4); //meter.volume*width*1.4, height);

        // set up the next visual callback
        rafID = window.requestAnimationFrame( drawLoop );
    }

    </script>
</body>
</html>
